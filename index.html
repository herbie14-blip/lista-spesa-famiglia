<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista spesa famiglia Bonatti</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librerie per il PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937, #4b5563);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem 1rem;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        .btn-main {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .item-list-btn {
            @apply flex-grow p-3 m-1 rounded-lg text-sm md:text-base transition-all duration-200 ease-in-out transform hover:scale-105 hover:bg-opacity-90;
        }
        /* Stili per la lista */
        .list-item {
            animation: fadeIn 0.5s ease-out;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .item-checked {
            text-decoration: line-through;
            color: #9ca3af;
            transform: translateX(10px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="text-white">

    <!-- Container principale -->
    <div class="container bg-gray-800 p-6 rounded-3xl shadow-2xl">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-yellow-400">
            Lista spesa famiglia Bonatti
        </h1>
        <p class="text-center text-sm mb-4 text-gray-400">ID Lista: <span id="user-id" class="font-mono text-gray-300"></span></p>

        <!-- Sezione per la lista della spesa -->
        <div id="list-to-export" class="bg-gray-700 rounded-2xl p-4 mb-6 shadow-inner">
            <h2 class="text-2xl font-semibold mb-4">La tua spesa</h2>
            <ul id="shopping-list" class="space-y-3">
                <!-- Gli elementi della lista verranno aggiunti qui dinamicamente -->
            </ul>
        </div>

        <!-- Sezione per l'inserimento manuale -->
        <div class="flex mb-6 bg-gray-700 p-3 rounded-2xl shadow-inner flex-col sm:flex-row gap-2 sm:gap-0">
            <input type="text" id="manual-item-input" class="flex-grow p-3 rounded-xl sm:rounded-l-xl sm:rounded-r-none bg-gray-900 text-white placeholder-gray-500 border-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Aggiungi un nuovo articolo..." disabled>
            <button id="add-manual-item-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-xl sm:rounded-r-xl sm:rounded-l-none btn-main" disabled>Aggiungi</button>
        </div>

        <!-- Elenco articoli predefiniti con menu a tendina -->
        <div class="bg-gray-700 rounded-2xl p-4 mb-6 shadow-inner">
            <h2 class="text-2xl font-semibold mb-4">Scegli dalla lista</h2>
            <div class="flex gap-2 items-center flex-col sm:flex-row">
                <select id="predefined-item-select" class="flex-grow p-3 rounded-xl bg-gray-900 text-white border-none focus:outline-none focus:ring-2 focus:ring-purple-500 w-full" disabled>
                    <option value="" disabled selected>Caricamento articoli...</option>
                </select>
                <button id="add-predefined-item-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-xl btn-main w-full sm:w-auto" disabled>Aggiungi</button>
            </div>
        </div>

        <!-- Sezione volantini -->
        <div class="bg-gray-700 rounded-2xl p-4 mb-6 shadow-inner">
            <h2 class="text-2xl font-semibold mb-4">Volantini</h2>
            <div class="flex justify-between gap-4 flex-wrap">
                <a href="https://www.pennymarket.it/volantino/volantino-settimanale" target="_blank" class="flex-1 text-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl btn-main min-w-[120px]">Penny Market</a>
                <a href="https://www.migross.it/volantino" target="_blank" class="flex-1 text-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl btn-main min-w-[120px]">Migross</a>
                <a href="https://www.conad.it/volantini" target="_blank" class="flex-1 text-center bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 rounded-xl btn-main min-w-[120px]">Conad</a>
            </div>
        </div>
        
        <!-- Pulsante Esporta PDF -->
        <div class="flex justify-center mt-6">
            <button id="export-pdf-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl btn-main w-full">Esporta in PDF</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        setLogLevel('Debug');

        // Variabili globali fornite dall'ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let isAuthReady = false;

        // Elenco dettagliato degli articoli raggruppati per categoria
        const categorizedItems = {
            "Frutta e Verdura": ["Mele", "Banane", "Insalata", "Patate", "Pomodori", "Zucchine", "Cetrioli", "Carote", "Arance", "Limoni", "Cipolle", "Aglio", "Peperoni", "Melanzane", "Uva"],
            "Latticini e Uova": ["Latte", "Uova", "Yogurt", "Formaggio", "Burro", "Ricotta", "Mozzarella", "Panna", "Mascarpone", "Stracchino"],
            "Panetteria": ["Pane", "Focaccia", "Grissini", "Pizza", "Brioche", "Pancarré", "Taralli", "Piadina"],
            "Cereali e Pasta": ["Pasta", "Riso", "Farina", "Couscous", "Gnocchi", "Cereali", "Avena", "Granola", "Legumi secchi", "Lenticchie", "Fagioli"],
            "Carne e Pesce": ["Pollo", "Manzo", "Maiale", "Salumi", "Prosciutto cotto", "Prosciutto crudo", "Salsiccia", "Tonno in scatola", "Salmone", "Merluzzo", "Gamberi", "Acciughe"],
            "Snack e Dolci": ["Biscotti", "Cioccolato", "Patatine", "Caramelle", "Gelato", "Torte", "Merendine", "Snack salati", "Ciambelle", "Pistacchi", "Nocciole", "Mandorle"],
            "Bevande": ["Acqua", "Succo di frutta", "Bibite gassate", "Vino", "Birra", "Caffè", "Tè", "Latte di soia", "Latte di mandorla"],
            "Oli e Condimenti": ["Olio", "Sale", "Zucchero", "Aceto", "Salsa di pomodoro", "Maionese", "Ketchup", "Senape", "Spezie", "Basilico", "Origano"],
            "Igiene e Casa": ["Carta igienica", "Detersivo per piatti", "Sapone", "Shampoo", "Bagnoschiuma", "Dentifricio", "Spazzolino", "Ammorbidente", "Tovaglioli", "Sacchi per spazzatura", "Candele"],
            "Surgelati": ["Patatine fritte", "Piselli", "Spinaci", "Verdure miste", "Pizza surgelata", "Gelato"],
            "Conserve e Vasetti": ["Tonno", "Fagioli in scatola", "Pelati", "Mais", "Sottaceti", "Marmellata", "Miele"],
            "Altro": ["Cibo per animali", "Pile", "Fazzoletti", "Fiori", "Riviste", "Farmaci da banco"]
        };

        // Funzione per generare il menu a tendina
        function createPredefinedSelectMenu() {
            const predefinedSelect = document.getElementById('predefined-item-select');
            // Pulisce il menu prima di ricrearlo
            predefinedSelect.innerHTML = '<option value="" disabled selected>Seleziona un articolo...</option>';
            for (const category in categorizedItems) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                categorizedItems[category].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    optgroup.appendChild(option);
                });
                predefinedSelect.appendChild(optgroup);
            }
        }

        // Funzione per abilitare/disabilitare gli elementi dell'interfaccia utente
        function toggleUIState(isEnabled) {
            document.getElementById('manual-item-input').disabled = !isEnabled;
            document.getElementById('add-manual-item-btn').disabled = !isEnabled;
            document.getElementById('predefined-item-select').disabled = !isEnabled;
            document.getElementById('add-predefined-item-btn').disabled = !isEnabled;
            
            if (isEnabled) {
                document.getElementById('predefined-item-select').querySelector('option[disabled]').textContent = 'Seleziona un articolo...';
                document.getElementById('add-manual-item-btn').textContent = 'Aggiungi';
                document.getElementById('add-predefined-item-btn').textContent = 'Aggiungi';
            } else {
                document.getElementById('predefined-item-select').querySelector('option[disabled]').textContent = 'Caricamento articoli...';
                document.getElementById('add-manual-item-btn').textContent = 'Connessione...';
                document.getElementById('add-predefined-item-btn').textContent = 'Connessione...';
            }
        }

        // Aggiungi un articolo alla lista Firestore
        async function addItem(name) {
            if (!name.trim() || !isAuthReady) {
                console.log("Non è possibile aggiungere l'articolo. L'input è vuoto o l'autenticazione non è pronta.");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/shopping_list`), {
                    name: name,
                    completed: false,
                    timestamp: new Date()
                });
                document.getElementById('manual-item-input').value = '';
                document.getElementById('predefined-item-select').value = ''; // Resetta il menu a tendina
            } catch (e) {
                console.error("Errore nell'aggiungere il documento: ", e);
            }
        }

        // Renderizza la lista della spesa dal database
        function renderList(items) {
            const shoppingListUl = document.getElementById('shopping-list');
            shoppingListUl.innerHTML = ''; // Pulisce la lista esistente
            if (items.length === 0) {
                const emptyMsg = document.createElement('p');
                emptyMsg.textContent = "La lista è vuota. Aggiungi qualcosa!";
                emptyMsg.className = "text-center text-gray-400 italic";
                shoppingListUl.appendChild(emptyMsg);
            }
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = `list-item flex items-center justify-between p-3 rounded-xl bg-gray-900 shadow-lg`;
                
                const itemText = document.createElement('span');
                itemText.textContent = item.name;
                itemText.className = `flex-grow text-lg ${item.completed ? 'item-checked' : 'text-white'}`;
                
                // Pulsanti per le azioni
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex space-x-2';

                const completeBtn = document.createElement('button');
                completeBtn.textContent = '✅'; // Emoji per l'icona
                completeBtn.className = 'text-xl p-1 rounded-full hover:bg-green-600 transition-colors';
                completeBtn.onclick = async () => {
                    if (!isAuthReady) return;
                    try {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/shopping_list`, item.id), {
                            completed: !item.completed
                        });
                    } catch (e) {
                        console.error("Errore nell'aggiornare il documento: ", e);
                    }
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '🗑️'; // Emoji per l'icona
                deleteBtn.className = 'text-xl p-1 rounded-full hover:bg-red-600 transition-colors';
                deleteBtn.onclick = async () => {
                    if (!isAuthReady) return;
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/shopping_list`, item.id));
                    } catch (e) {
                        console.error("Errore nell'eliminare il documento: ", e);
                    }
                };

                li.appendChild(itemText);
                actionsDiv.appendChild(completeBtn);
                actionsDiv.appendChild(deleteBtn);
                li.appendChild(actionsDiv);
                shoppingListUl.appendChild(li);
            });
        }

        // Funzione per esportare la lista in PDF
        async function exportToPdf() {
            const exportBtn = document.getElementById('export-pdf-btn');
            const originalText = exportBtn.textContent;
            exportBtn.disabled = true;
            exportBtn.textContent = 'Generazione PDF in corso...';

            // Utilizza la funzione del browser per la stampa
            window.print();

            exportBtn.disabled = false;
            exportBtn.textContent = originalText;
        }

        // Ascoltatori di eventi
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('add-manual-item-btn').addEventListener('click', () => {
                const manualItemInput = document.getElementById('manual-item-input');
                addItem(manualItemInput.value);
            });

            document.getElementById('manual-item-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const manualItemInput = document.getElementById('manual-item-input');
                    addItem(manualItemInput.value);
                }
            });

            document.getElementById('add-predefined-item-btn').addEventListener('click', () => {
                const predefinedSelect = document.getElementById('predefined-item-select');
                const selectedItem = predefinedSelect.value;
                if (selectedItem) {
                    addItem(selectedItem);
                }
            });

            document.getElementById('export-pdf-btn').addEventListener('click', exportToPdf);

            // Genera il menu a tendina all'avvio
            createPredefinedSelectMenu();
            toggleUIState(false); // Disabilita l'UI finché l'autenticazione non è pronta
        });

        // Autenticazione e ascolto in tempo reale del database
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                document.getElementById('user-id').textContent = userId;
                toggleUIState(true); // Abilita l'UI
                
                const q = query(collection(db, `artifacts/${appId}/public/data/shopping_list`));
                onSnapshot(q, (querySnapshot) => {
                    const items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    // Ordina gli elementi in base al timestamp per mantenere l'ordine di inserimento
                    items.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate()); 
                    renderList(items);
                });
            } else {
                console.log("Nessun utente autenticato, autenticazione in corso...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Errore di autenticazione:", error);
                }
            }
        });

    </script>
</body>
</html>
